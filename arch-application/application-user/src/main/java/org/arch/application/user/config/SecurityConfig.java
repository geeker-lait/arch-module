//package org.arch.application.user.properties;
//
//import com.uni.common.annotation.AnonymousAccess;
//import com.uni.skit.user.properties.security.JwtAccessDeniedHandler;
//import com.uni.skit.user.properties.security.JwtAuthenticationEntryPoint;
//import com.uni.skit.user.properties.security.TokenConfigurer;
//import com.uni.skit.user.properties.security.TokenProvider;
//import org.springframework.context.ApplicationContext;
//import org.springframework.context.annotation.Bean;
//import org.springframework.context.annotation.Configuration;
//import org.springframework.http.HttpMethod;
//import org.springframework.security.properties.annotation.method.configuration.EnableGlobalMethodSecurity;
//import org.springframework.security.properties.annotation.web.builders.HttpSecurity;
//import org.springframework.security.properties.annotation.web.configuration.EnableWebSecurity;
//import org.springframework.security.properties.annotation.web.configuration.WebSecurityConfigurerAdapter;
//import org.springframework.security.properties.core.GrantedAuthorityDefaults;
//import org.springframework.security.properties.http.SessionCreationPolicy;
//import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
//import org.springframework.security.crypto.password.PasswordEncoder;
//import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
//import org.springframework.web.filter.CorsFilter;
//import org.springframework.web.method.HandlerMethod;
//import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
//import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;
//
//import java.util.HashSet;
//import java.util.Map;
//import java.util.Set;
//
//@Configuration
//@EnableWebSecurity
//@EnableGlobalMethodSecurity(prePostEnabled = true)
//public class SecurityConfig extends WebSecurityConfigurerAdapter {
//
//    private final TokenProvider tokenProvider;
//    private final CorsFilter corsFilter;
//    private final JwtAuthenticationEntryPoint authenticationErrorHandler;
//    private final JwtAccessDeniedHandler jwtAccessDeniedHandler;
//    private final ApplicationContext applicationContext;
//
//    public SecurityConfig(TokenProvider tokenProvider, CorsFilter corsFilter, JwtAuthenticationEntryPoint authenticationErrorHandler, JwtAccessDeniedHandler jwtAccessDeniedHandler, ApplicationContext applicationContext) {
//        this.tokenProvider = tokenProvider;
//        this.corsFilter = corsFilter;
//        this.authenticationErrorHandler = authenticationErrorHandler;
//        this.jwtAccessDeniedHandler = jwtAccessDeniedHandler;
//        this.applicationContext = applicationContext;
//    }
//
//    @Bean
//    GrantedAuthorityDefaults grantedAuthorityDefaults() {
//        // 去除 ROLE_ 前缀
//        return new GrantedAuthorityDefaults("");
//    }
//
//    @Bean
//    public PasswordEncoder passwordEncoder() {
//        // 密码加密方式
//        return new BCryptPasswordEncoder();
//    }
//
//
//    /**
//     * anyRequest          |   匹配所有请求路径
//     * access              |   SpringEl表达式结果为true时可以访问
//     * anonymous           |   匿名可以访问
//     * denyAll             |   用户不能访问
//     * fullyAuthenticated  |   用户完全认证可以访问（非remember-me下自动登录）
//     * hasAnyAuthority     |   如果有参数，参数表示权限，则其中任何一个权限可以访问
//     * hasAnyRole          |   如果有参数，参数表示角色，则其中任何一个角色可以访问
//     * hasAuthority        |   如果有参数，参数表示权限，则其权限可以访问
//     * hasIpAddress        |   如果有参数，参数表示IP地址，如果用户IP和参数匹配，则可以访问
//     * hasRole             |   如果有参数，参数表示角色，则其角色可以访问
//     * permitAll           |   用户可以任意访问
//     * rememberMe          |   允许通过remember-me登录的用户访问
//     * authenticated       |   用户登录后可访问
//     */
//    @Override
//    protected void configure(HttpSecurity httpSecurity) throws Exception {
//        // 搜寻匿名标记 url： @AnonymousAccess
//        Map<RequestMappingInfo, HandlerMethod> handlerMethodMap = applicationContext.getBean(RequestMappingHandlerMapping.class).getHandlerMethods();
//        Set<String> anonymousUrls = new HashSet<>();
//        for (Map.Entry<RequestMappingInfo, HandlerMethod> infoEntry : handlerMethodMap.entrySet()) {
//            HandlerMethod handlerMethod = infoEntry.getValue();
//            AnonymousAccess anonymousAccess = handlerMethod.getMethodAnnotation(AnonymousAccess.class);
//            if (null != anonymousAccess) {
//                anonymousUrls.addAll(infoEntry.getKey().getPatternsCondition().getPatterns());
//            }
//        }
//        httpSecurity
//                // 禁用 CSRF
//                .csrf().disable()
//                .addFilterBefore(corsFilter, UsernamePasswordAuthenticationFilter.class)
//                // 授权异常
//                .exceptionHandling()
//                .authenticationEntryPoint(authenticationErrorHandler)
//                .accessDeniedHandler(jwtAccessDeniedHandler)
//
//                // 防止iframe 造成跨域
//                .and()
//                .headers()
//                .frameOptions()
//                .disable()
//
//                // 不创建会话
//                .and()
//                .sessionManagement()
//                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
//
//                .and()
//                .authorizeRequests()
//                // 静态资源等等
//                .antMatchers(
//                        HttpMethod.GET,
//                        "/*.html",
//                        "/**/*.html",
//                        "/**/*.css",
//                        "/**/*.js",
//                        "/webSocket/**"
//                ).permitAll()
//
//                // swagger
//                .antMatchers("/swagger-ui.html").permitAll()
//                .antMatchers("/swagger-resources/**").permitAll()
//                .antMatchers("/webjars/**").permitAll()
//                .antMatchers("/*/api-docs").permitAll()
//
//                // 文件
//                .antMatchers("/avatar/**").permitAll()
//                .antMatchers("/file/**").permitAll()
//                // druid
//                .antMatchers("/druid/**").permitAll()
//                .antMatchers("/initauth/**").permitAll()
//                .antMatchers("/statistics/**").permitAll()
//                .antMatchers("/promotion/**").permitAll()
//
//
//                // 放行OPTIONS请求
//                .antMatchers(HttpMethod.OPTIONS, "/**").permitAll()
//                // 自定义匿名访问所有url放行 ： 允许匿名和带权限以及登录用户访问
//                .antMatchers(anonymousUrls.toArray(new String[0])).permitAll()
//                // 所有请求都需要认证
//                .anyRequest().authenticated()
//                .and().apply(securityConfigurerAdapter());
//    }
//
//    private TokenConfigurer securityConfigurerAdapter() {
//        return new TokenConfigurer(tokenProvider);
//    }
//}
//
